-- 1. 'account_book' 데이터베이스가 없다면 새로 생성합니다.
--    CHARACTER SET과 COLLATE 설정은 한글이 깨지지 않게 하기 위함입니다.
CREATE DATABASE IF NOT EXISTS account_book
    CHARACTER SET utf8mb4
    COLLATE utf8mb4_unicode_ci;

-- 2. 앞으로 이 데이터베이스를 사용하겠다고 지정합니다.
USE account_book;

-- 3. 'users' 테이블을 생성합니다.
CREATE TABLE IF NOT EXISTS users (
    -- id: 고유 번호, 기본 키(PRIMARY KEY), 자동으로 1씩 증가(AUTO_INCREMENT)
    id            INT AUTO_INCREMENT PRIMARY KEY,
   
    -- username: 아이디(이메일), 비어있을 수 없고(NOT NULL), 중복될 수 없음(UNIQUE)
    username      VARCHAR(255) NOT NULL UNIQUE,
   
    -- name: 사용자 이름, 비어있어도 됨(NULL)
    name          VARCHAR(100) NULL,
   
    -- password_hash: 암호화된 비밀번호, 비어있을 수 없음
    password_hash VARCHAR(255) NOT NULL,
   
    -- created_at: 계정 생성일, 데이터 생성 시 자동으로 현재 시간이 기록됨
    created_at    TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
ALTER TABLE users MODIFY COLUMN password_hash VARCHAR(255) NULL;
ALTER TABLE users ADD COLUMN provider VARCHAR(50) NOT NULL DEFAULT 'local';
-- "role 컬럼의 속성을 NOT NULL DEFAULT 'user'로 변경"
ALTER TABLE users MODIFY COLUMN role VARCHAR(50) NOT NULL DEFAULT 'user';
CREATE TABLE transactions (
    id INT AUTO_INCREMENT PRIMARY KEY,
    user_id INT NOT NULL,
    type ENUM('expense', 'income') NOT NULL,
    amount DECIMAL(15, 2) NOT NULL,
    description VARCHAR(255) NOT NULL,
    category VARCHAR(50) NOT NULL,
    transaction_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id)
);

/* 'role' 컬럼이 비어있는(IS NULL) 모든 사용자를 'user'로 업데이트합니다. */
UPDATE moonkyu312
SET role = 'user' 
WHERE role IS NULL;


-- 4. 테이블이 잘 만들어졌는지 확인하는 명령어 (선택 사항)
SELECT * FROM users;
SELECT * FROM transactions;
 SELECT * FROM account_book.users;
DELETE FROM account_book.users
WHERE id = '9';

INSERT INTO users (username, name, password_hash, role)
VALUES (
    'admin@gmail.com',
    'admin',
    '$2b$10$s8GWVNJWmhpddNuZmt7EEun1LdlUQPlSb7Wtl2sYcP3A9FtbwUpH6',
    'admin'
);

SELECT username, role FROM users WHERE username = 'admin@gmail.com';
UPDATE users SET role = 'admin' WHERE username = 'admin@gmail.com';

CREATE TABLE IF NOT EXISTS categories (
    id INT AUTO_INCREMENT PRIMARY KEY,
    user_id INT NULL, -- 사용자가 추가한 카테고리의 경우에만 user_id가 기록됩니다.
    name VARCHAR(50) NOT NULL,
    is_default BOOLEAN DEFAULT FALSE, -- TRUE이면 모든 사용자가 보는 기본 카테고리입니다.
    -- 사용자가 삭제(탈퇴)되면, 해당 사용자가 만든 카테고리도 함께 삭제됩니다.
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
);

-- 모든 사용자가 공통으로 사용할 기본 카테고리를 추가합니다.
-- IGNORE는 이미 데이터가 있을 경우 오류 없이 넘어가도록 합니다.
INSERT IGNORE INTO categories (name, is_default) VALUES
('식비', TRUE),
('교통비', TRUE),
('쇼핑', TRUE),
('문화생활', TRUE),
('월급', TRUE);


ALTER TABLE transactions DROP FOREIGN KEY transactions_ibfk_1;

-- 3-2. `ON DELETE CASCADE` 옵션이 포함된 새로운 외래 키 제약 조건을 추가합니다.
ALTER TABLE transactions
ADD CONSTRAINT fk_user_transactions
FOREIGN KEY (user_id)
REFERENCES users(id)
ON DELETE CASCADE;